@using SGHR.Web.Models.EnumsModel.Operaciones
@using SGHR.Web.Models.EnumsModel.Reserva
@model SGHR.Web.Areas.Administrador.Models.DashboardViewModel


<div class="container-fluid px-4 mt-4">

    <h2 class="mb-4 text-center fw-bold text-success">Dashboard General</h2>

    <!-- Tarjetas de resumen -->
    <div class="row g-4 mb-4">
        <div class="col-md-3">
            <div class="card text-white bg-success shadow-sm text-center">
                <div class="card-body">
                    <h6 class="card-title">Total Recaudado</h6>
                    <h3 class="fw-bold">@Model.ResumenPago.TotalRecaudado.ToString("C")</h3>
                </div>
            </div>
        </div>

        <div class="col-md-3">
            <div class="card text-white bg-primary shadow-sm text-center">
                <div class="card-body">
                    <h6 class="card-title">Pagos Completados</h6>
                    <h3 class="fw-bold">@Model.ResumenPago.Completados</h3>
                </div>
            </div>
        </div>

        <div class="col-md-3">
            <div class="card text-white bg-warning shadow-sm text-center">
                <div class="card-body">
                    <h6 class="card-title">Pagos Pendientes</h6>
                    <h3 class="fw-bold">@Model.ResumenPago.Pendientes</h3>
                </div>
            </div>
        </div>

        <div class="col-md-3">
            <div class="card text-white bg-danger shadow-sm text-center">
                <div class="card-body">
                    <h6 class="card-title">Pagos Rechazados</h6>
                    <h3 class="fw-bold">@Model.ResumenPago.Rechazados</h3>
                </div>
            </div>
        </div>
    </div>

    <!-- Gráfico -->
    <div class="card shadow-sm mb-4">
        <div class="card-header bg-white fw-bold">
            Ingresos por Mes
        </div>
        <div class="card-body">
            <canvas id="chartIngresos" height="120"></canvas>
        </div>
    </div>

    <!-- Tablas -->
    <div class="row g-4">
        <!-- Últimos Pagos -->
        <div class="col-md-6">
            <div class="card shadow-sm">
                <div class="card-header bg-white fw-bold">
                    Últimos Pagos
                </div>
                <div class="card-body p-0">
                    <table class="table table-striped mb-0">
                        <thead class="table-light">
                            <tr>
                                <th>ID</th>
                                <th>Monto</th>
                                <th>Estado</th>
                                <th>Fecha</th>
                            </tr>
                        </thead>
                        <tbody>
                            @if (Model.Pago.Any())
                            {
                                foreach (var pago in Model.Pago)
                                {
                                    <tr>
                                        <td>@pago.Id</td>
                                        <td>@pago.Monto.ToString("C")</td>
                                        <td>
                                            <span class="badge @(pago.Estado == EstadoPagoModel.Completado ? "bg-success" : pago.Estado == EstadoPagoModel.Pendiente ? "bg-warning" : "bg-danger")">
                                                @pago.Estado
                                            </span>
                                        </td>
                                        <td>@pago.FechaPago.ToShortDateString()</td>
                                    </tr>
                                }
                            }
                            else
                            {
                                <tr>
                                    <td colspan="4" class="text-center text-muted">No hay pagos registrados.</td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Reservas Recientes -->
        <div class="col-md-6">
            <div class="card shadow-sm">
                <div class="card-header bg-white fw-bold">
                    Reservas Recientes
                </div>
                <div class="card-body p-0">
                    <table class="table table-striped mb-0">
                        <thead class="table-light">
                            <tr>
                                <th>Cliente</th>
                                <th>Habitación</th>
                                <th>Estado</th>
                                <th>Inicio</th>
                            </tr>
                        </thead>
                        <tbody>
                            @if (Model.Reserva.Any())
                            {
                                foreach (var reserva in Model.Reserva)
                                {
                                    <tr>
                                        <td>@reserva.CedulaCliente</td>
                                        <td>@reserva.NumeroHabitacion</td>
                                        <td>
                                            @{
                                                var estadoTexto = reserva.Estado switch
                                                {
                                                    EstadoReservaModel.Pendiente => "Pendiente",
                                                    EstadoReservaModel.Confirmada => "Confirmada",
                                                    EstadoReservaModel.Activa => "Activa",
                                                    EstadoReservaModel.Finalizada => "Finalizada",  
                                                    EstadoReservaModel.Cancelada => "Cancelada",
                                                    EstadoReservaModel.PagoParcial => "Pago Parcial",    
                                                    _ => "Desconocido"
                                                };

                                                var color = reserva.Estado == EstadoReservaModel.Confirmada ? "bg-success" :
                                                            reserva.Estado == EstadoReservaModel.Cancelada ? "bg-danger" :
                                                            "bg-secondary";
                                            }

                                            <span class="badge @color">
                                                @estadoTexto
                                            </span>
                                        </td>
                                        <td>@reserva.FechaInicio.ToShortDateString()</td>
                                    </tr>
                                }
                            }
                            else
                            {
                                <tr>
                                    <td colspan="4" class="text-center text-muted">No hay reservas registradas.</td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        // Filtrar pagos no rechazados
        const pagosValidos = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(
            Model.Pago.Where(p => p.Estado != EstadoPagoModel.Rechazado)
                       .Select(p => new { 
                           fecha = p.FechaPago.ToString("yyyy-MM-dd"), 
                           monto = p.Monto 
                       })
        ));

        // Agrupar por mes
        const ingresosPorMes = Array(12).fill(0);
        pagosValidos.forEach(p => {
            const mes = new Date(p.fecha).getMonth(); // 0 = Ene
            ingresosPorMes[mes] += p.monto;
        });

        // Gráfico dinámico
        const ctx = document.getElementById('chartIngresos').getContext('2d');
        new Chart(ctx, {
            type: 'line',
            data: {
                labels: ['Ene', 'Feb', 'Mar', 'Abr', 'May', 'Jun', 'Jul', 'Ago', 'Sep', 'Oct', 'Nov', 'Dic'],
                datasets: [{
                    label: 'Ingresos (RD$)',
                    data: ingresosPorMes,
                    borderColor: 'rgba(54, 162, 235, 1)',
                    backgroundColor: 'rgba(54, 162, 235, 0.2)',
                    borderWidth: 2,
                    fill: true,
                    tension: 0.3
                }]
            },
            options: {
                responsive: true,
                scales: {
                    y: { beginAtZero: true }
                }
            }
        });
    </script>
}
